<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Roadbox Controller</title>
    <style>
        body { 
            background-color: #222; color: white; font-family: 'Arial', sans-serif; 
            margin: 0; height: 100vh; display: flex; flex-direction: column; align-items: center;
            user-select: none; -webkit-user-select: none; /* Disable text selection */
        }
        h2 { margin-top: 20px; }
        #status { color: #888; font-size: 14px; margin-bottom: 20px; }
        
        /* CONNECTION BUTTON */
        #connectBtn {
            padding: 12px 25px; font-size: 16px; border-radius: 8px; border: none;
            background: #007bff; color: white; font-weight: bold; cursor: pointer;
        }
        
        /* CONTROLLER LAYOUT */
        .control-grid {
            display: grid;
            grid-template-columns: 100px 100px 100px;
            grid-template-rows: 100px 100px;
            gap: 15px;
            margin-top: 50px;
        }

        .btn {
            width: 100px; height: 100px;
            border-radius: 15px; border: none;
            font-size: 24px; font-weight: bold; color: white;
            background: #444; box-shadow: 0 6px #222;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            /* CRITICAL FIX: prevents scrolling when dragging finger off button */
            touch-action: none; 
        }

        /* BUTTON COLORS & PRESS EFFECT */
        .btn:active, .btn.pressed {
            box-shadow: 0 2px #222;
            transform: translateY(4px);
            background-color: #555;
        }

        .up { background: #28a745; grid-column: 2; grid-row: 1; } /* Green */
        .down { background: #dc3545; grid-column: 2; grid-row: 2; } /* Red */
        .left { background: #ffc107; color: black; grid-column: 1; grid-row: 2; } /* Yellow */
        .right { background: #ffc107; color: black; grid-column: 3; grid-row: 2; } /* Yellow */

        /* LOG BOX */
        #log {
            margin-top: 30px; font-family: monospace; color: #0f0; font-size: 12px;
        }
    </style>
</head>
<body>

    <h2>Mission Roadbox</h2>
    <div id="status">Disconnected</div>
    <button id="connectBtn" onclick="connectBLE()">CONNECT ROBOT</button>

    <div class="control-grid">
        <button class="btn up" 
            onpointerdown="sendCommand(140, 100)" 
            onpointerup="stop()" 
            onpointerleave="stop()"
            onpointercancel="stop()">
            ▲
        </button>

        <button class="btn left" 
            onpointerdown="sendCommand(100, 50)" 
            onpointerup="stop()" 
            onpointerleave="stop()"
            onpointercancel="stop()">
            ◀
        </button>

        <button class="btn down" 
            onpointerdown="sendCommand(60, 100)" 
            onpointerup="stop()" 
            onpointerleave="stop()"
            onpointercancel="stop()">
            ▼
        </button>

        <button class="btn right" 
            onpointerdown="sendCommand(100, 150)" 
            onpointerup="stop()" 
            onpointerleave="stop()"
            onpointercancel="stop()">
            ▶
        </button>
    </div>

    <div id="log">Last Cmd: Stop</div>

    <script>
        // --- CONFIGURATION ---
        const serviceUUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const charUUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        let bleDevice, bleServer, bleService, bleChar;
        let isConnected = false;
        
        // --- QUEUE VARIABLES (Fixes the Bluetooth Traffic Jam) ---
        let isWriting = false;
        let pendingData = null;

        async function connectBLE() {
            try {
                updateStatus("Scanning...");
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Roadbox_Controller' }],
                    optionalServices: [serviceUUID]
                });

                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
                updateStatus("Connecting...");
                bleServer = await bleDevice.gatt.connect();
                bleService = await bleServer.getPrimaryService(serviceUUID);
                bleChar = await bleService.getCharacteristic(charUUID);

                isConnected = true;
                updateStatus("CONNECTED", "green");
                document.getElementById('connectBtn').style.display = 'none';

            } catch (error) {
                console.log(error);
                updateStatus("Error: " + error, "red");
            }
        }

        function onDisconnected() {
            isConnected = false;
            updateStatus("Disconnected", "red");
            document.getElementById('connectBtn').style.display = 'block';
        }

        function updateStatus(text, color="gray") {
            const el = document.getElementById('status');
            el.innerText = text;
            el.style.color = color;
        }

        // --- COMMAND SENDER (With Queueing) ---
        function sendCommand(throttle, steer) {
            if (!bleChar || !isConnected) return;

            // Update Log
            let action = "Stop";
            if(throttle > 100) action = "Forward";
            if(throttle < 100) action = "Reverse";
            if(steer < 100) action = "Left";
            if(steer > 100) action = "Right";
            document.getElementById('log').innerText = "Cmd: " + action + " (T:" + throttle + " S:" + steer + ")";

            // Queue the data instead of sending blindly
            pendingData = new Uint8Array([throttle, steer]);
            processQueue();
        }

        // This function safely sends data without jamming the Bluetooth radio
        async function processQueue() {
            if (isWriting || !pendingData || !bleChar || !isConnected) return;

            isWriting = true;
            let dataToSend = pendingData;
            pendingData = null; // Clear queue so we only send the freshest data

            try {
                // Use 'writeValueWithoutResponse' if available (much faster for joysticks)
                if (bleChar.writeValueWithoutResponse) {
                    await bleChar.writeValueWithoutResponse(dataToSend);
                } else {
                    await bleChar.writeValue(dataToSend);
                }
            } catch(e) {
                console.log("Send Error:", e);
            }

            isWriting = false;

            // If a Stop command came in while we were busy sending Go, process it immediately
            if (pendingData) {
                setTimeout(processQueue, 10);
            }
        }

        // Helper to send STOP command (100, 100)
        function stop() {
            sendCommand(100, 100);
        }
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Roadbox Controller</title>
    <style>
        * { box-sizing: border-box; }

        body {
            background-color: #1a1a2e;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
        }

        h2 { margin-top: 20px; font-size: 22px; letter-spacing: 2px; }

        #status {
            font-size: 13px;
            margin: 6px 0 14px;
            padding: 4px 14px;
            border-radius: 20px;
            background: #333;
        }
        #status.connected    { background: #1a4a1a; color: #4cff4c; }
        #status.disconnected { background: #4a1a1a; color: #ff6060; }
        #status.scanning     { background: #1a3a4a; color: #60c0ff; }

        #connectBtn {
            padding: 12px 28px;
            font-size: 15px;
            border-radius: 10px;
            border: none;
            background: #0077cc;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }
        #connectBtn:hover { background: #0099ff; }

        .dpad {
            display: grid;
            grid-template-columns: 110px 110px 110px;
            grid-template-rows: 110px 110px;
            gap: 12px;
            margin-top: 40px;
        }

        .btn {
            width: 110px; height: 110px;
            border-radius: 16px;
            border: 2px solid rgba(255,255,255,0.1);
            font-size: 28px;
            color: white;
            background: #2d2d44;
            box-shadow: 0 7px #111;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 4px;
            touch-action: none;
            transition: transform 0.05s, box-shadow 0.05s;
            -webkit-tap-highlight-color: transparent;
        }
        .btn span.label { font-size: 10px; color: rgba(255,255,255,0.5); }

        .btn.pressed {
            box-shadow: 0 2px #111;
            transform: translateY(5px);
            background: #3d3d5c;
        }

        .up    { background: #1a5c2a; grid-column: 2; grid-row: 1; }
        .down  { background: #7a1a1a; grid-column: 2; grid-row: 2; }
        .left  { background: #5c4a00; grid-column: 1; grid-row: 2; }
        .right { background: #5c4a00; grid-column: 3; grid-row: 2; }

        #log {
            margin-top: 28px;
            font-family: monospace;
            font-size: 13px;
            color: #aaa;
            background: #111;
            padding: 8px 20px;
            border-radius: 8px;
            min-width: 280px;
            text-align: center;
        }

        #https-warning {
            display: none;
            color: #ff6060;
            font-size: 12px;
            margin-top: 10px;
            background: #4a1a1a;
            padding: 8px 16px;
            border-radius: 8px;
            max-width: 320px;
            text-align: center;
        }
    </style>
</head>
<body>

    <h2>üöó Mission Roadbox</h2>
    <div id="status" class="disconnected">Disconnected</div>
    <button id="connectBtn" onclick="connectBLE()">CONNECT ROBOT</button>
    <div id="https-warning">
        ‚ö†Ô∏è Web Bluetooth requires HTTPS or localhost.
    </div>

    <div class="dpad">
        <button class="btn up"
            onpointerdown="press(this, 160, 100)"
            onpointerup="release(this)"
            onpointerleave="release(this)"
            onpointercancel="release(this)">
            ‚ñ≤ <span class="label">FORWARD</span>
        </button>

        <button class="btn left"
            onpointerdown="press(this, 100, 40)"
            onpointerup="release(this)"
            onpointerleave="release(this)"
            onpointercancel="release(this)">
            ‚óÄ <span class="label">LEFT</span>
        </button>

        <button class="btn down"
            onpointerdown="press(this, 40, 100)"
            onpointerup="release(this)"
            onpointerleave="release(this)"
            onpointercancel="release(this)">
            ‚ñº <span class="label">REVERSE</span>
        </button>

        <button class="btn right"
            onpointerdown="press(this, 100, 160)"
            onpointerup="release(this)"
            onpointerleave="release(this)"
            onpointercancel="release(this)">
            ‚ñ∂ <span class="label">RIGHT</span>
        </button>
    </div>

    <div id="log">Last: Stop</div>

    <script>
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHAR_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        // ‚îÄ‚îÄ KEY FIX: repeat interval must be less than STM32 watchdog (500ms)
        // Send every 200ms while button is held so watchdog never triggers
        const REPEAT_INTERVAL_MS = 200;

        let bleChar      = null;
        let isConnected  = false;
        let repeatTimer  = null;   // holds the setInterval reference
        let activeBtn    = null;   // currently pressed button element
        let isSending    = false;  // prevents overlapping async sends

        // ‚îÄ‚îÄ HTTPS check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.addEventListener('load', () => {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                document.getElementById('https-warning').style.display = 'block';
            }
            if (!navigator.bluetooth) {
                updateStatus('Web Bluetooth not supported', 'disconnected');
                document.getElementById('connectBtn').disabled = true;
            }
        });

        // ‚îÄ‚îÄ BLE Connect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function connectBLE() {
            try {
                updateStatus('Scanning...', 'scanning');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Roadbox_Controller' }],
                    optionalServices: [SERVICE_UUID]
                });

                device.addEventListener('gattserverdisconnected', () => {
                    isConnected = false;
                    bleChar = null;
                    stopRepeat();
                    updateStatus('Disconnected', 'disconnected');
                    document.getElementById('connectBtn').style.display = 'inline-block';
                    updateLog('Stop', 100, 100);
                });

                updateStatus('Connecting...', 'scanning');
                const server  = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                bleChar       = await service.getCharacteristic(CHAR_UUID);

                isConnected = true;
                updateStatus('CONNECTED ‚úì', 'connected');
                document.getElementById('connectBtn').style.display = 'none';

                // Confirm link with a stop packet
                await sendCommand(100, 100);

            } catch (err) {
                console.error(err);
                updateStatus('Error: ' + err.message, 'disconnected');
            }
        }

        // ‚îÄ‚îÄ Button press: send immediately + start repeat timer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function press(el, throttle, steer) {
            // If another button is already held, release it first
            if (activeBtn && activeBtn !== el) {
                activeBtn.classList.remove('pressed');
            }

            activeBtn = el;
            el.classList.add('pressed');
            el.setPointerCapture(event.pointerId);

            // Send immediately so there's no delay on first press
            sendCommand(throttle, steer);

            // Clear any existing timer
            stopRepeat();

            // FIX: Keep sending every REPEAT_INTERVAL_MS while button is held.
            // Without this the STM32 watchdog fires after 500ms and stops motors.
            repeatTimer = setInterval(() => {
                sendCommand(throttle, steer);
            }, REPEAT_INTERVAL_MS);
        }

        // ‚îÄ‚îÄ Button release: stop repeat + send stop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function release(el) {
            if (activeBtn !== el) return;  // ignore spurious events

            el.classList.remove('pressed');
            activeBtn = null;
            stopRepeat();
            sendCommand(100, 100);   // STOP
        }

        // ‚îÄ‚îÄ Clear the repeat timer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function stopRepeat() {
            if (repeatTimer !== null) {
                clearInterval(repeatTimer);
                repeatTimer = null;
            }
        }

        // ‚îÄ‚îÄ Send 2-byte BLE packet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function sendCommand(throttle, steer) {
            if (!bleChar || !isConnected) return;

            // Skip if previous send hasn't finished (BLE is slower than interval)
            if (isSending) return;
            isSending = true;

            updateLog(getLabel(throttle, steer), throttle, steer);

            try {
                const data = new Uint8Array([throttle, steer]);
                if (typeof bleChar.writeValueWithoutResponse === 'function') {
                    await bleChar.writeValueWithoutResponse(data);
                } else {
                    await bleChar.writeValue(data);
                }
            } catch (e) {
                // Don't log every failure during rapid repeat
                if (e.name !== 'NetworkError') {
                    console.warn('BLE send error:', e);
                }
            } finally {
                isSending = false;
            }
        }

        function getLabel(t, s) {
            if (t > 100 && s === 100) return 'Forward';
            if (t < 100 && s === 100) return 'Reverse';
            if (t === 100 && s < 100) return 'Left';
            if (t === 100 && s > 100) return 'Right';
            if (t === 100 && s === 100) return 'Stop';
            return 'Move';
        }

        function updateLog(label, t, s) {
            document.getElementById('log').innerText =
                `Last: ${label}  (T:${t}  S:${s})`;
        }

        function updateStatus(text, cls) {
            const el = document.getElementById('status');
            el.innerText = text;
            el.className = cls;
        }
    </script>
</body>
</html>
